"use client";

import { useState } from "react";
import { FaCheck, FaTimes, FaClock, FaPhone, FaCalendar, FaMapMarkerAlt, FaEnvelope, FaStickyNote, FaEdit } from "react-icons/fa";

const STATI = [
  { key: "contatto", label: "Contatto", icon: FaPhone },
  { key: "appuntamento", label: "Appuntamento", icon: FaCalendar },
  { key: "preventivo", label: "Preventivo", icon: FaStickyNote },
  { key: "contratto", label: "Contratto", icon: FaCheck }
];

export default function TimelineLead({ lead, onUpdate, onDelete, onArchive }) {
  const [isExpanded, setIsExpanded] = useState(false);
  const [isUpdating, setIsUpdating] = useState(false);
  const [dataRicontatto, setDataRicontatto] = useState("");
  
  // Editing nota generale
  const [isEditingNota, setIsEditingNota] = useState(false);
  const [notaGenerale, setNotaGenerale] = useState(lead.nota_generale || "");
  
  // Nuovo stato selezionato
  const [nuovoStato, setNuovoStato] = useState(lead.stato_attuale || "in_lavorazione");
  const [mostraDataRichiamo, setMostraDataRichiamo] = useState(false);

  const getStatoAttuale = () => {
    return lead.stato_attuale || "nuovo";
  };

  const isStatoCompletato = (statoKey) => {
    if (!lead.timeline || !lead.timeline[statoKey]) return false;
    return lead.timeline[statoKey]?.completato === true;
  };

  const getDataCompletamento = (statoKey) => {
    if (!lead.timeline || !lead.timeline[statoKey]) return null;
    const data = lead.timeline[statoKey]?.data_completamento;
    if (!data) return null;
    return new Date(data).toLocaleDateString("it-IT");
  };

  const handleToggleStato = async (statoKey) => {
    // Ordine della timeline
    const ordineStati = ["contatto", "appuntamento", "preventivo", "contratto"];
    const indiceCliccato = ordineStati.indexOf(statoKey);
    
    const currentValue = isStatoCompletato(statoKey);
    
    if (currentValue) {
      // Se √® gi√† spuntato, deseleziona QUESTO e tutti quelli DOPO
      await aggiornaTimelineProgressiva(indiceCliccato, false, statoKey);
    } else {
      // Se non √® spuntato, spunta QUESTO e tutti quelli PRIMA
      await aggiornaTimelineProgressiva(indiceCliccato, true, statoKey);
    }
  };

  const aggiornaTimelineProgressiva = async (indiceTarget, completare, statoKey) => {
    setIsUpdating(true);
    try {
      const ordineStati = ["contatto", "appuntamento", "preventivo", "contratto"];
      const updateData = {};
      
      if (completare) {
        // Spunta tutti gli stati da 0 fino all'indice cliccato (incluso)
        for (let i = 0; i <= indiceTarget; i++) {
          const stato = ordineStati[i];
          updateData[`timeline.${stato}.completato`] = true;
          updateData[`timeline.${stato}.data_completamento`] = new Date().toISOString();
        }
        
        // Se clicca su "contratto", imposta stato_attuale a "completato"
        if (statoKey === 'contratto') {
          updateData.stato_attuale = 'completato';
        }
      } else {
        // Deseleziona dall'indice cliccato fino alla fine
        for (let i = indiceTarget; i < ordineStati.length; i++) {
          const stato = ordineStati[i];
          updateData[`timeline.${stato}.completato`] = false;
          updateData[`timeline.${stato}.data_completamento`] = null;
        }
        
        // Se toglie "contratto", riporta lo stato a "in_lavorazione"
        if (statoKey === 'contratto') {
          updateData.stato_attuale = 'in_lavorazione';
        }
      }

      const response = await fetch(`/api/leads/${lead._id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(updateData)
      });

      if (!response.ok) throw new Error("Errore aggiornamento");

      const updatedLead = await response.json();
      onUpdate(updatedLead);
    } catch (error) {
      console.error("Errore:", error);
      alert("Errore durante l'aggiornamento");
    } finally {
      setIsUpdating(false);
    }
  };

  const handleNonInteressato = async () => {
    const conferma = confirm(
      "‚ùå NON INTERESSATO\n\n" +
      "Il cliente non √® interessato.\n" +
      "Lo stato verr√† impostato su 'Non Interessato'.\n\n" +
      "Confermi?"
    );
    
    if (!conferma) return;

    setIsUpdating(true);
    try {
      const response = await fetch(`/api/leads/${lead._id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          stato_attuale: "non_interessato"
        })
      });

      if (!response.ok) throw new Error("Errore aggiornamento");

      const updatedLead = await response.json();
      onUpdate(updatedLead);
      alert("‚úÖ Lead impostato come NON INTERESSATO");
    } catch (error) {
      console.error("Errore:", error);
      alert("Errore durante l'aggiornamento");
    } finally {
      setIsUpdating(false);
    }
  };

  const handleDaRichiamare = async () => {
    if (!dataRicontatto) {
      alert("‚ö†Ô∏è Inserisci una data per programmare il richiamo");
      return;
    }

    const conferma = confirm(
      "ÔøΩ DA RICHIAMARE\n\n" +
      `Data richiamo: ${new Date(dataRicontatto).toLocaleDateString('it-IT')}\n\n` +
      "Lo stato verr√† impostato su 'Da Richiamare'.\n\n" +
      "Confermi?"
    );
    
    if (!conferma) return;

    setIsUpdating(true);
    try {
      const response = await fetch(`/api/leads/${lead._id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          stato_attuale: "da_richiamare",
          data_richiamo: dataRicontatto
        })
      });

      if (!response.ok) throw new Error("Errore programmazione");

      const updatedLead = await response.json();
      onUpdate(updatedLead);
      setDataRicontatto("");
      alert(`‚úÖ Lead da richiamare il ${new Date(dataRicontatto).toLocaleDateString('it-IT')}`);
    } catch (error) {
      console.error("Errore:", error);
      alert("Errore durante la programmazione");
    } finally {
      setIsUpdating(false);
    }
  };

  const handleSalvaNota = async () => {
    setIsUpdating(true);
    try {
      const response = await fetch(`/api/leads/${lead._id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          nota_generale: notaGenerale
        })
      });

      if (!response.ok) throw new Error("Errore salvataggio nota");

      const updatedLead = await response.json();
      onUpdate(updatedLead);
      setIsEditingNota(false);
      alert("‚úÖ Nota salvata");
    } catch (error) {
      console.error("Errore:", error);
      alert("Errore durante il salvataggio della nota");
    } finally {
      setIsUpdating(false);
    }
  };

  const handleElimina = async () => {
    if (!confirm(`Eliminare definitivamente il lead "${lead.nome_attivita}"?`)) return;

    setIsUpdating(true);
    try {
      const response = await fetch(`/api/leads/${lead._id}`, {
        method: "DELETE"
      });

      if (!response.ok) throw new Error("Errore eliminazione");

      onDelete(lead._id);
    } catch (error) {
      console.error("Errore:", error);
      alert("Errore durante l'eliminazione");
    } finally {
      setIsUpdating(false);
    }
  };

  const statoAttuale = getStatoAttuale();
  const isArchiviato = lead.archiviato;

  return (
    <>
      <div className={`border rounded-lg p-4 mb-3 shadow-sm transition-all ${
        isArchiviato ? "bg-gray-100 opacity-75" : "bg-white hover:shadow-md"
      }`}>
        {/* Header Lead */}
        <div className="flex items-start justify-between mb-3">
          <div className="flex-1">
            <h3 className="text-lg font-bold text-gray-800">{lead.nome_attivita}</h3>
            {lead.referente && (
              <p className="text-sm text-gray-600">üìû {lead.referente}</p>
            )}
            <p className="text-sm text-blue-600 font-medium">{lead.numero_telefono}</p>
          </div>
          
          <div className="flex flex-col items-end gap-1">
            <span className={`px-3 py-1 rounded-full text-xs font-semibold ${
              statoAttuale === "in_lavorazione" ? "bg-blue-100 text-blue-800" :
              statoAttuale === "non_interessato" ? "bg-red-100 text-red-800" :
              statoAttuale === "da_richiamare" ? "bg-yellow-100 text-yellow-800" :
              statoAttuale === "completato" ? "bg-green-100 text-green-800" :
              "bg-gray-100 text-gray-800"
            }`}>
              {statoAttuale === "in_lavorazione" ? "IN LAVORAZIONE" :
               statoAttuale === "non_interessato" ? "NON INTERESSATO" :
               statoAttuale === "da_richiamare" ? "DA RICHIAMARE" :
               statoAttuale === "completato" ? "COMPLETATO" :
               statoAttuale.toUpperCase()}
            </span>
            
            {lead.data_richiamo && statoAttuale === "da_richiamare" && (
              <span className="px-2 py-1 bg-yellow-50 text-yellow-700 rounded text-xs">
                üìÖ {new Date(lead.data_richiamo).toLocaleDateString('it-IT')}
              </span>
            )}
            
            {isArchiviato && (
              <span className="px-2 py-1 bg-red-100 text-red-800 rounded text-xs font-semibold">
                ARCHIVIATO
              </span>
            )}
          </div>
        </div>

        {/* Timeline Stati */}
        <div className="grid grid-cols-4 gap-2 mb-3">
          {STATI.map((stato, idx) => {
            const Icon = stato.icon;
            const completato = isStatoCompletato(stato.key);
            const dataComp = getDataCompletamento(stato.key);

            return (
              <button
                key={stato.key}
                onClick={() => !isUpdating && !isArchiviato && handleToggleStato(stato.key)}
                disabled={isUpdating || isArchiviato}
                className={`p-3 rounded-lg border-2 transition-all ${
                  completato 
                    ? "border-green-500 bg-green-50" 
                    : "border-gray-300 bg-gray-50 hover:border-blue-400 hover:bg-blue-50"
                } ${isArchiviato ? "cursor-not-allowed opacity-50" : "cursor-pointer"}`}
              >
                <div className="flex flex-col items-center gap-1">
                  <Icon className={`text-xl ${completato ? "text-green-600" : "text-gray-400"}`} />
                  <span className={`text-xs font-medium ${completato ? "text-green-700" : "text-gray-600"}`}>
                    {stato.label}
                  </span>
                  {completato && (
                    <>
                      <FaCheck className="text-green-600 text-sm" />
                      {dataComp && (
                        <span className="text-[10px] text-gray-500">{dataComp}</span>
                      )}
                    </>
                  )}
                </div>
              </button>
            );
          })}
        </div>

        {/* NOTA GENERALE - Sempre Visibile */}
        <div className="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-3 mb-3">
          <div className="flex items-start justify-between gap-2 mb-2">
            <div className="flex items-center gap-2">
              <FaStickyNote className="text-yellow-600" />
              <span className="font-semibold text-gray-700 text-sm">Nota Generale</span>
            </div>
            {!isArchiviato && (
              <button
                onClick={() => {
                  if (isEditingNota) {
                    handleSalvaNota();
                  } else {
                    setIsEditingNota(true);
                  }
                }}
                disabled={isUpdating}
                className="text-blue-600 hover:text-blue-800 text-xs font-medium flex items-center gap-1"
              >
                <FaEdit />
                {isEditingNota ? "Salva" : "Modifica"}
              </button>
            )}
          </div>
          
          {isEditingNota ? (
            <textarea
              value={notaGenerale}
              onChange={(e) => setNotaGenerale(e.target.value)}
              placeholder="Aggiungi note, dettagli, promemoria..."
              className="w-full border border-yellow-300 rounded p-2 text-sm min-h-[80px] focus:outline-none focus:ring-2 focus:ring-yellow-400"
              disabled={isUpdating}
            />
          ) : (
            <p className="text-sm text-gray-700 whitespace-pre-wrap">
              {notaGenerale || <span className="text-gray-400 italic">Nessuna nota inserita...</span>}
            </p>
          )}
          
          {isEditingNota && (
            <button
              onClick={() => {
                setNotaGenerale(lead.nota_generale || "");
                setIsEditingNota(false);
              }}
              className="text-xs text-gray-500 hover:text-gray-700 mt-2"
              disabled={isUpdating}
            >
              Annulla modifiche
            </button>
          )}
        </div>

        {/* Dettagli Aggiuntivi */}
        {isExpanded && (
          <div className="mt-3 pt-3 border-t border-gray-200 space-y-2 text-sm">
            {lead.indirizzo && (
              <p className="flex items-center gap-2">
                <FaMapMarkerAlt className="text-gray-400" />
                <span>{lead.indirizzo}</span>
                {lead.citta && <span className="text-gray-600">- {lead.citta}</span>}
              </p>
            )}
            {lead.email && (
              <p className="flex items-center gap-2">
                <FaEnvelope className="text-gray-400" />
                <span>{lead.email}</span>
              </p>
            )}
            {lead.secondo_numero && (
              <p className="flex items-center gap-2">
                <FaPhone className="text-gray-400" />
                <span>{lead.secondo_numero}</span>
              </p>
            )}
          </div>
        )}

        {/* Azioni */}
        {!isArchiviato && (
          <div className="mt-3 pt-3 border-t border-gray-200">
            <div className="flex flex-wrap gap-2 items-center mb-3">
              <button
                onClick={() => setIsExpanded(!isExpanded)}
                className="text-xs text-blue-600 hover:text-blue-800 font-medium"
              >
                {isExpanded ? "Nascondi dettagli ‚ñ≤" : "Mostra dettagli ‚ñº"}
              </button>

              <button
                onClick={handleElimina}
                disabled={isUpdating}
                className="text-xs text-red-600 hover:text-red-800 font-medium ml-auto"
              >
                Elimina
              </button>
            </div>

            {/* Spiegazione Azioni */}
            <div className="bg-gray-50 rounded-lg p-3 space-y-3">
              <p className="text-xs text-gray-600 font-medium mb-2">Cambia stato lead:</p>
              
              {/* NON INTERESSATO */}
              <div className="flex items-start gap-3">
                <button
                  onClick={handleNonInteressato}
                  disabled={isUpdating}
                  className="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 disabled:opacity-50 text-sm font-medium flex items-center gap-2 whitespace-nowrap"
                >
                  <FaTimes />
                  Non Interessato
                </button>
                <p className="text-xs text-gray-600 leading-relaxed">
                  ‚ùå <strong>Cliente non vuole</strong> ‚Üí Imposta stato su "Non Interessato"
                </p>
              </div>

              {/* DA RICHIAMARE */}
              <div className="flex items-start gap-3">
                <div className="flex items-center gap-2">
                  <input
                    type="date"
                    value={dataRicontatto}
                    onChange={(e) => setDataRicontatto(e.target.value)}
                    min={new Date().toISOString().split('T')[0]}
                    className="text-sm border border-gray-300 rounded px-2 py-2"
                    disabled={isUpdating}
                  />
                  <button
                    onClick={handleDaRichiamare}
                    disabled={isUpdating || !dataRicontatto}
                    className="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600 disabled:opacity-50 text-sm font-medium flex items-center gap-2 whitespace-nowrap"
                  >
                    <FaClock />
                    Da Richiamare
                  </button>
                </div>
                <p className="text-xs text-gray-600 leading-relaxed">
                  ÔøΩ <strong>Richiamalo in una data specifica</strong> ‚Üí Imposta promemoria per ricontattare
                </p>
              </div>
              
              <div className="pt-2 border-t border-gray-200">
                <p className="text-xs text-gray-500 italic">
                  üí° <strong>Tip:</strong> Quando clicchi su "Contratto" nella timeline, lo stato diventer√† automaticamente "COMPLETATO"
                </p>
              </div>
            </div>
          </div>
        )}
      </div>
    </>
  );
}
